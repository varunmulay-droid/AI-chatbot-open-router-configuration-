<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic AI Chatbot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-bg: #1a1a2e;
            --darker-bg: #16213e;
            --accent-color: #0f3460;
        }

        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-header {
            background: var(--secondary-gradient);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            display: inline-block;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 10px;
        }

        .message {
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            text-align: right;
        }

        .ai-message {
            text-align: left;
        }

        .message-bubble {
            display: inline-block;
            max-width: 70%;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
        }

        .user-message .message-bubble {
            background: var(--success-gradient);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .ai-message .message-bubble {
            background: white;
            color: #333;
            border: 2px solid #e9ecef;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .chat-input-container {
            padding: 1.5rem;
            background: white;
            border-radius: 0 0 20px 20px;
            border-top: 1px solid #e9ecef;
        }

        .input-group {
            position: relative;
        }

        .form-control {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }

        .btn-send {
            background: var(--primary-gradient);
            border: none;
            border-radius: 25px;
            width: 50px;
            height: 50px;
            margin-left: 10px;
            transition: all 0.3s ease;
            color: white;
        }

        .btn-send:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 5px;
            color: #667eea;
            font-style: italic;
            padding: 0.5rem 1rem;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .memory-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .settings-panel {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .api-key-input {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }

        .api-key-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .clear-btn {
            background: var(--secondary-gradient);
            border: none;
            color: white;
            border-radius: 10px;
            transition: transform 0.3s ease;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.3);
        }

        @media (max-width: 768px) {
            .chat-messages {
                height: 400px;
            }
            
            .message-bubble {
                max-width: 85%;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <!-- Settings Panel -->
                <div class="settings-panel">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text bg-transparent border-0">
                                    <i class="fas fa-key text-muted"></i>
                                </span>
                                <input type="password" class="form-control api-key-input" 
                                       id="apiKey" placeholder="Enter your OpenRouter API Key">
                            </div>
                        </div>
                        <div class="col-md-4 mt-2 mt-md-0">
                            <button class="btn clear-btn w-100" onclick="clearChat()">
                                <i class="fas fa-trash-alt me-2"></i>Clear Chat
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Chat Container -->
                <div class="chat-container">
                    <div class="chat-header">
                        <h4 class="mb-0">
                            <i class="fas fa-robot me-2"></i>
                            AI Assistant
                            <span class="status-indicator"></span>
                        </h4>
                        <small>Powered by Dolphin Mistral with Memory</small>
                        <div class="memory-indicator" id="memoryIndicator">
                            Memory: 0 messages
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message">
                            <div class="message-bubble">
                                <i class="fas fa-sparkles me-2"></i>
                                Hello! I'm your AI assistant with memory capabilities. I can remember our conversation context to provide more personalized and relevant responses. How can I help you today?
                            </div>
                            <div class="message-time text-muted">
                                <small>Just now</small>
                            </div>
                        </div>
                    </div>

                    <div class="typing-indicator" id="typingIndicator">
                        <i class="fas fa-brain me-2"></i>
                        AI is thinking
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>

                    <div class="chat-input-container">
                        <div class="input-group">
                            <input type="text" class="form-control" id="messageInput" 
                                   placeholder="Type your message here..." 
                                   onkeypress="handleKeyPress(event)">
                            <button class="btn btn-send" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // Memory Management System
        class ChatMemory {
            constructor(maxMessages = 20) {
                this.messages = [];
                this.maxMessages = maxMessages;
                this.context = {
                    userPreferences: {},
                    conversationThemes: [],
                    importantFacts: []
                };
            }

            addMessage(role, content) {
                const message = {
                    role: role,
                    content: content,
                    timestamp: new Date().toISOString(),
                    importance: this.calculateImportance(content)
                };

                this.messages.push(message);
                this.updateContext(message);
                this.maintainMemorySize();
                this.updateMemoryIndicator();
            }

            calculateImportance(content) {
                // Algorithm to determine message importance
                let importance = 0;
                
                // Keywords that indicate important information
                const importantKeywords = ['remember', 'important', 'prefer', 'like', 'dislike', 'always', 'never', 'my name', 'I am'];
                const questionKeywords = ['what', 'how', 'why', 'when', 'where', 'who'];
                
                importantKeywords.forEach(keyword => {
                    if (content.toLowerCase().includes(keyword)) {
                        importance += 2;
                    }
                });

                questionKeywords.forEach(keyword => {
                    if (content.toLowerCase().includes(keyword)) {
                        importance += 1;
                    }
                });

                // Length-based importance
                if (content.length > 100) importance += 1;
                if (content.length > 200) importance += 1;

                return Math.min(importance, 5);
            }

            updateContext(message) {
                // Extract and store contextual information
                const content = message.content.toLowerCase();
                
                // Extract user preferences
                if (content.includes('i like') || content.includes('i prefer') || content.includes('i love')) {
                    const preference = content.split(/i (like|prefer|love)/)[1]?.trim();
                    if (preference) {
                        this.context.userPreferences[preference] = 'positive';
                    }
                }

                if (content.includes('i dislike') || content.includes('i hate') || content.includes('i don\'t like')) {
                    const preference = content.split(/i (dislike|hate|don't like)/)[1]?.trim();
                    if (preference) {
                        this.context.userPreferences[preference] = 'negative';
                    }
                }

                // Track conversation themes
                this.extractThemes(content);
            }

            extractThemes(content) {
                const themes = ['technology', 'science', 'art', 'music', 'sports', 'food', 'travel', 'business', 'education', 'health'];
                themes.forEach(theme => {
                    if (content.includes(theme)) {
                        if (!this.context.conversationThemes.includes(theme)) {
                            this.context.conversationThemes.push(theme);
                        }
                    }
                });
            }

            maintainMemorySize() {
                if (this.messages.length > this.maxMessages) {
                    // Keep high-importance messages and recent messages
                    const sortedByImportance = [...this.messages].sort((a, b) => b.importance - a.importance);
                    const importantMessages = sortedByImportance.slice(0, Math.floor(this.maxMessages * 0.3));
                    const recentMessages = this.messages.slice(-Math.floor(this.maxMessages * 0.7));
                    
                    // Merge and deduplicate
                    const keptMessages = new Map();
                    [...importantMessages, ...recentMessages].forEach(msg => {
                        keptMessages.set(msg.timestamp, msg);
                    });
                    
                    this.messages = Array.from(keptMessages.values())
                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                }
            }

            getContextualMessages() {
                // Return messages formatted for API with context
                const contextSummary = this.generateContextSummary();
                const apiMessages = [...this.messages.map(msg => ({
                    role: msg.role,
                    content: msg.content
                }))];

                if (contextSummary && apiMessages.length > 0) {
                    apiMessages[0] = {
                        role: "system",
                        content: `Context from previous conversation: ${contextSummary}\n\nUser message: ${apiMessages[0]?.content || ''}`
                    };
                }

                return apiMessages;
            }

            generateContextSummary() {
                let summary = "";
                
                if (Object.keys(this.context.userPreferences).length > 0) {
                    summary += "User preferences: ";
                    Object.entries(this.context.userPreferences).forEach(([pref, sentiment]) => {
                        summary += `${sentiment === 'positive' ? 'likes' : 'dislikes'} ${pref}; `;
                    });
                }

                if (this.context.conversationThemes.length > 0) {
                    summary += `Conversation themes: ${this.context.conversationThemes.join(', ')}. `;
                }

                return summary.trim();
            }

            updateMemoryIndicator() {
                const indicator = document.getElementById('memoryIndicator');
                if (indicator) {
                    indicator.textContent = `Memory: ${this.messages.length} messages`;
                }
            }

            clear() {
                this.messages = [];
                this.context = {
                    userPreferences: {},
                    conversationThemes: [],
                    importantFacts: []
                };
                this.updateMemoryIndicator();
            }
        }

        // Initialize chat memory
        const chatMemory = new ChatMemory();

        // API Configuration
        const API_CONFIG = {
            url: "https://openrouter.ai/api/v1/chat/completions",
            model: "cognitivecomputations/dolphin-mistral-24b-venice-edition:free",
            maxTokens: 1000,
            temperature: 0.7
        };

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(content, isUser = false, animate = true) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            if (animate) {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(20px)';
            }

            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${isUser ? '' : '<i class="fas fa-robot me-2"></i>'}
                    ${content}
                </div>
                <div class="message-time text-muted">
                    <small>${currentTime}</small>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);

            if (animate) {
                setTimeout(() => {
                    messageDiv.style.transition = 'all 0.3s ease-out';
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                }, 50);
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Add to memory
            chatMemory.addMessage(isUser ? 'user' : 'assistant', content);
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const apiKeyInput = document.getElementById('apiKey');
            const message = messageInput.value.trim();
            const apiKey = sessionApiKey || apiKeyInput.value.trim();

            if (!message) return;

            if (!apiKey) {
                addMessage('‚ö†Ô∏è Please enter your OpenRouter API key in the settings above.', false);
                return;
            }

            // Update session API key
            sessionApiKey = apiKey;

            // Add user message
            addMessage(message, true);
            messageInput.value = '';

            // Show typing indicator
            showTypingIndicator();

            try {
                // Check if we're in a CORS-restricted environment
                if (window.location.protocol === 'file:' || window.location.hostname === 'claude.ai' || window.location.hostname.includes('anthropic')) {
                    throw new Error('CORS Restriction: Direct API calls are blocked in this environment. Please copy this code to your own server or local environment to use with real API calls.');
                }

                // Prepare messages for API
                const apiMessages = [];
                
                // Add context from memory if available
                const contextualMessages = chatMemory.getContextualMessages();
                if (contextualMessages.length > 1) {
                    // Include recent conversation history (last 5 messages max for API efficiency)
                    const recentMessages = contextualMessages.slice(-5);
                    apiMessages.push(...recentMessages);
                }
                
                // Add current user message
                apiMessages.push({
                    role: "user",
                    content: message
                });

                console.log('Sending to API:', { model: API_CONFIG.model, messages: apiMessages });

                const response = await fetch(API_CONFIG.url, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "HTTP-Referer": window.location.origin,
                        "X-Title": "Dynamic AI Chatbot",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.model,
                        messages: apiMessages,
                        max_tokens: API_CONFIG.maxTokens,
                        temperature: API_CONFIG.temperature
                    })
                });

                hideTypingIndicator();

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Response:', response.status, errorText);
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error?.message || errorMessage;
                    } catch (e) {
                        // Use default error message if JSON parsing fails
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                const aiResponse = data.choices?.[0]?.message?.content || "Sorry, I couldn't generate a response.";
                
                // Add AI response with typing effect
                typewriterEffect(aiResponse);

            } catch (error) {
                hideTypingIndicator();
                console.error('Error:', error);
                
                // Provide more helpful error messages
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    addMessage(`üö´ <strong>CORS Error:</strong> This chatbot needs to run on your own server or localhost to make API calls. 
                    <br><br>üìã <strong>To use this code:</strong>
                    <br>1. Copy the HTML code to a .html file
                    <br>2. Open it in your browser from a local server (like Live Server in VS Code)
                    <br>3. Or deploy it to your own web hosting
                    <br><br>üîß The interface and memory system work perfectly - just the API calls are restricted in this preview environment.`, false);
                } else {
                    addMessage(`‚ùå <strong>Error:</strong> ${error.message}`, false);
                }
            }
        }

        function typewriterEffect(text) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            
            // Generate unique ID for this message
            const uniqueId = 'typewriter_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <i class="fas fa-robot me-2"></i>
                    <span id="${uniqueId}"></span>
                    <span class="cursor">|</span>
                </div>
                <div class="message-time text-muted">
                    <small>${currentTime}</small>
                </div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            const typewriterElement = document.getElementById(uniqueId);
            const cursor = messageDiv.querySelector('.cursor');
            let i = 0;

            function typeChar() {
                if (i < text.length) {
                    typewriterElement.textContent += text.charAt(i);
                    i++;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    setTimeout(typeChar, 30);
                } else {
                    cursor.style.display = 'none';
                    // Add to memory after typing is complete
                    chatMemory.addMessage('assistant', text);
                }
            }

            typeChar();
        }

        function clearChat() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="message ai-message">
                    <div class="message-bubble">
                        <i class="fas fa-sparkles me-2"></i>
                        Hello! I'm your AI assistant with memory capabilities. I can remember our conversation context to provide more personalized and relevant responses. How can I help you today?
                    </div>
                    <div class="message-time text-muted">
                        <small>Just now</small>
                    </div>
                </div>
            `;
            
            // Clear memory
            chatMemory.clear();
        }

        // Store API key in memory during session
        let sessionApiKey = '';

        // Auto-focus on message input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('messageInput').focus();
            
            // Save API key in memory on change
            document.getElementById('apiKey').addEventListener('input', function() {
                sessionApiKey = this.value;
            });
        });

        // Add some CSS for the cursor animation
        const style = document.createElement('style');
        style.textContent = `
            .cursor {
                animation: blink 1s infinite;
            }
            
            @keyframes blink {
                0%, 50% { opacity: 1; }
                51%, 100% { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>